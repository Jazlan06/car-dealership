<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" href="styles/login-signup.css" />
  <link rel="stylesheet" href="styles/index.css">
  <link
    rel="stylesheet"
    href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css"
    integrity="sha512-SnH5WK+bZxgPHs44uWIX+LLJAJ9/2PkPKZ5QiAj6Ta86w+fsb2TkcmfRyVX3pBnMFcV7oQPJkl9QevSCWr3W6A=="
    crossorigin="anonymous"
    referrerpolicy="no-referrer"
  />
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="icon" href="/Images/favicon.ico" type="image/x-icon">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link
    href="https://fonts.googleapis.com/css2?family=Poppins:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&display=swap"
    rel="stylesheet"
  />
  <title>Login Page</title>
</head>
<body>
  <div id="header-container"></div>

  <div class="sign-out-container">
    <button id="signOutButton" class="sign-out-button">Sign Out</button>
  </div>
  
  <!-- Container for unauthenticated users -->
  <div class="container" id="container">
    <div class="sign-up">
      <form id="signUpForm">
        <h1>Create Account</h1>
        <input id="name" type="text" placeholder="Name" required />
        <input id="number" type="number" placeholder="Number" required />
        <input id="email" type="email" placeholder="Email" required />
        <input id="password" type="password" placeholder="Password" required />
        <button type="submit" class="sign-up-button">Sign Up</button>
      </form>
    </div>
    
    <div class="sign-in">
      <form id="signInForm">
        <h1 id="sign-in-css">Sign In</h1>
        <input id="signInEmail" type="email" placeholder="Email" required />
        <input id="signInPassword" type="password" placeholder="Password" required />
        <button type="submit">Sign In</button>
      </form>
    </div>
    <div class="toogle-container">
      <div class="toogle">
        <div class="toogle-panel toogle-left">
          <h1>Welcome User!</h1>
          <p>If you already have an account</p>
          <button class="hidden" id="login">Sign In</button>
        </div>
        <div class="toogle-panel toogle-right">
          <h1>Hello, User!</h1>
          <p>If you don't have an account</p>
          <button class="hidden" id="register">Sign Up</button>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Container for authenticated users -->
  <div class="authenticated" id="authenticated" style="display: none;">
    <h1>Already Signed In</h1>
    <p>Welcome back! <a href="used-cars.html">Explore Cars &#62;</a></p>
  </div>

  <script src="scripts/login-signup.js"></script>
  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js';
    import { getDatabase, ref, set, update, query, orderByChild, equalTo, get } from 'https://www.gstatic.com/firebasejs/10.12.4/firebase-database.js';
    import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.12.4/firebase-auth.js';

    // Your web app's Firebase configuration
    const firebaseConfig = {
      apiKey: "AIzaSyBbW-ykyHFkqzbSDNgKvISi4h3HrRTe-OQ",
      authDomain: "authentication-app-edfdd.firebaseapp.com",
      databaseURL: "https://authentication-app-edfdd-default-rtdb.firebaseio.com",
      projectId: "authentication-app-edfdd",
      storageBucket: "authentication-app-edfdd.appspot.com",
      messagingSenderId: "438700275480",
      appId: "1:438700275480:web:13f057e765938bf174106d"
    };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const database = getDatabase(app);

    // Check authentication state
    onAuthStateChanged(auth, (user) => {
      if (user) {
        // User is signed in
        document.querySelector('.container').style.display = 'none';
        document.querySelector('.sign-out-container').style.display = 'block';
        document.querySelector('.authenticated').style.display = 'block';
      } else {
        // User is not signed in
        document.querySelector('.container').style.display = 'block';
        document.querySelector('.authenticated').style.display = 'none';
        document.querySelector('.sign-out-container').style.display = 'none';
      }
    });

    // Handle sign-up form submission
    document.getElementById('signUpForm').addEventListener('submit', async (e) => {
      e.preventDefault(); // Prevent the default form submission

      // Get form values
      const name = document.getElementById('name').value;
      const number = document.getElementById('number').value;
      const email = document.getElementById('email').value;
      const password = document.getElementById('password').value;

      try {
        // Check if email already exists
        const emailQuery = query(ref(database, 'users'), orderByChild('email'), equalTo(email));
        const emailSnapshot = await get(emailQuery);
        if (emailSnapshot.exists()) {
          throw new Error('Email already in use');
        }

        // Check if phone number already exists
        const numberQuery = query(ref(database, 'users'), orderByChild('number'), equalTo(number));
        const numberSnapshot = await get(numberQuery);
        if (numberSnapshot.exists()) {
          throw new Error('Phone number already in use');
        }

        // Create user with email and password
        const userCredential = await createUserWithEmailAndPassword(auth, email, password);
        const user = userCredential.user;

        // Save additional user details in Realtime Database
        const userRef = ref(database, 'users/' + user.uid);
        await set(userRef, {
          name: name,
          number: number,
          email: email,
          createdAt: new Date().toISOString()
        });

        alert('User Created and Details Saved!');
        document.getElementById('signUpForm').reset();
      } catch (error) {
        const errorMessage = error.message;
        alert(`Error: ${errorMessage}`);
      }
    });

    // Handle sign-in form submission
    document.getElementById('signInForm').addEventListener('submit', async (e) => {
      e.preventDefault(); // Prevent the default form submission

      // Get form values
      const email = document.getElementById('signInEmail').value;
      const password = document.getElementById('signInPassword').value;

      try {
        // Sign in user with email and password
        const userCredential = await signInWithEmailAndPassword(auth, email, password);
        const user = userCredential.user;

        // Update sign-in timestamp in Realtime Database
        const userRef = ref(database, 'users/' + user.uid);
        await update(userRef, {
          lastSignIn: new Date().toISOString()
        });

        alert('Signed In Successfully!');
        document.getElementById('signInForm').reset();
        // Optionally, redirect the user or update the UI
        window.location.href = 'used-cars.html'; // Example of redirection
      } catch (error) {
        const errorMessage = error.message;
        alert(`Error: ${errorMessage}`);
      }
    });

     // Handle sign-out button click
     document.getElementById('signOutButton').addEventListener('click', async () => {
      try {
        await signOut(auth);
        alert('Signed Out Successfully!');
        // Optionally, redirect the user or update the UI
        window.location.href = 'login-signup.html'; // Example of redirection
      } catch (error) {
        const errorMessage = error.message;
        alert(`Error: ${errorMessage}`);
      }
    });
  </script>
</body>
</html>
